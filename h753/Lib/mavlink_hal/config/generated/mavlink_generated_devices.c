/**
 * @file mavlink_generated_devices.c
 * @brief Auto-generated device initialization and management
 *
 * Generated from: stm32h753_rover.yaml
 * Platform: STM32
 * Generated: 2025-11-11T20:26:05.902152
 * Checksum: c54c0f51df61f4dd
 * Generator Version: 1.0.0
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Any changes will be overwritten on next generation.
 */

#include "mavlink_generated_config.h"
#include "mavlink_generated_params.h"

/* Include platform-specific headers */
#ifdef STM32H7xx
#include "stm32h7xx_hal.h"
#elif defined(STM32F4xx)
#include "stm32f4xx_hal.h"
#elif defined(STM32F7xx)
#include "stm32f7xx_hal.h"
#endif

/* Include motor controllers */
#include "App/motors/servo_controller.h"
#include "App/motors/dc_controller.h"
#include "App/motors/robomaster_controller.h"
#include "App/motors/rs485_controller.h"

/* Include hardware manager */
#include "App/hal/hardware_manager.h"

/* ========================================================================== */
/*  SERVO CONFIGURATION DATA                                                  */
/* ========================================================================== */

const mavlink_gen_servo_config_t mavlink_gen_servo_configs[MAVLINK_GEN_SERVO_COUNT] = {
    {
        .id = 1,
        .name = "front_left_gripper",
        .timer_id = TIM1,
        .channel = TIM_CHANNEL_1,
        .min_pulse_us = 1000,
        .max_pulse_us = 2000,
        .min_angle = -90.000000f,
        .max_angle = 90.000000f,
        .neutral_angle = 0.000000f,
    },
    {
        .id = 2,
        .name = "front_right_gripper",
        .timer_id = TIM1,
        .channel = TIM_CHANNEL_2,
        .min_pulse_us = 1000,
        .max_pulse_us = 2000,
        .min_angle = -90.0f,
        .max_angle = 90.0f,
        .neutral_angle = 0.000000f,
    },
};

/* Servo controller instances */
static servo_controller_t* servo_controllers[MAVLINK_GEN_SERVO_COUNT];

/* ========================================================================== */
/*  DC MOTOR CONFIGURATION DATA                                               */
/* ========================================================================== */

const mavlink_gen_dc_motor_config_t mavlink_gen_dc_motor_configs[MAVLINK_GEN_DC_MOTOR_COUNT] = {
    {
        .id = 10,
        .name = "left_drive_wheel",
        .timer_id = TIM3,
        .channel = TIM_CHANNEL_3,
        .max_rpm = 100.000000f,
        .has_encoder = false,
        .encoder_ppr = 0,
    },
    {
        .id = 11,
        .name = "right_drive_wheel",
        .timer_id = TIM2,
        .channel = TIM_CHANNEL_3,
        .max_rpm = 100.000000f,
        .has_encoder = false,
        .encoder_ppr = 0,
    },
};

/* DC motor controller instances */
static dc_motor_controller_t* dc_motor_controllers[MAVLINK_GEN_DC_MOTOR_COUNT];

/* ========================================================================== */
/*  ROBOMASTER MOTOR CONFIGURATION DATA                                       */
/* ========================================================================== */

const mavlink_gen_robomaster_config_t mavlink_gen_robomaster_configs[MAVLINK_GEN_ROBOMASTER_COUNT] = {
    {
        .id = 20,
        .name = "turret_yaw",
        .can_id = 0x205,
        .motor_type = ROBOMASTER_MOTOR_TYPE_GM6020,
        .max_rpm = 320.000000f,
        .max_current = 10.0f,
    },
    {
        .id = 21,
        .name = "turret_pitch",
        .can_id = 0x206,
        .motor_type = ROBOMASTER_MOTOR_TYPE_GM6020,
        .max_rpm = 10000.0f,
        .max_current = 10.0f,
    },
    {
        .id = 22,
        .name = "flywheel_left",
        .can_id = 0x201,
        .motor_type = ROBOMASTER_MOTOR_TYPE_M3508,
        .max_rpm = 469.000000f,
        .max_current = 10000 / 1000.0f,
    },
    {
        .id = 23,
        .name = "flywheel_right",
        .can_id = 0x202,
        .motor_type = ROBOMASTER_MOTOR_TYPE_M3508,
        .max_rpm = 469.000000f,
        .max_current = 10000 / 1000.0f,
    },
};

/* RoboMaster controller instances */
static robomaster_controller_t* robomaster_controllers[MAVLINK_GEN_ROBOMASTER_COUNT];

/* ========================================================================== */
/*  RS485 MOTOR CONFIGURATION DATA                                            */
/* ========================================================================== */

const mavlink_gen_rs485_config_t mavlink_gen_rs485_configs[MAVLINK_GEN_RS485_MOTOR_COUNT] = {
    {
        .id = 30,
        .name = "conveyor_motor_1",
        .uart_port = ,
        .rs485_device_id = 1,
        .control_mode = RS485_MODE_VELOCITY,
        .max_rps = 100.000000f,
    },
    {
        .id = 31,
        .name = "conveyor_motor_2",
        .uart_port = ,
        .rs485_device_id = 2,
        .control_mode = RS485_MODE_POSITION,
        .max_rps = 50.000000f,
    },
};

/* RS485 controller instances */
static rs485_controller_t* rs485_controllers[MAVLINK_GEN_RS485_MOTOR_COUNT];

/* ========================================================================== */
/*  IMU SENSOR CONFIGURATION DATA                                             */
/* ========================================================================== */

const mavlink_gen_imu_config_t mavlink_gen_imu_configs[MAVLINK_GEN_IMU_COUNT] = {
    {
        .id = 110,
        .name = "main_imu",
        .sensor_type = "",
        .i2c_address = 0x68,
        .sample_rate_hz = 100,
    },
};

/* ========================================================================== */
/*  GPS MODULE CONFIGURATION DATA                                             */
/* ========================================================================== */


/* ========================================================================== */
/*  ANALOG SENSOR CONFIGURATION DATA                                          */
/* ========================================================================== */

const mavlink_gen_analog_sensor_config_t mavlink_gen_analog_sensor_configs[MAVLINK_GEN_ANALOG_SENSOR_COUNT] = {
    {
        .id = 100,
        .name = "battery_voltage",
        .sensor_type = ANALOG_SENSOR_VOLTAGE,
        .adc_channel = "",
        .scale_factor = 1.000000f,
        .offset = 0.000000f,
    },
    {
        .id = 101,
        .name = "motor_current",
        .sensor_type = ANALOG_SENSOR_CURRENT,
        .adc_channel = "",
        .scale_factor = 1.000000f,
        .offset = 0.000000f,
    },
};

/* ========================================================================== */
/*  DEVICE NAME LOOKUP                                                        */
/* ========================================================================== */

const char* mavlink_gen_get_device_name(uint8_t device_id) {
    if (device_id == 1) return "front_left_gripper";
    if (device_id == 2) return "front_right_gripper";
    if (device_id == 10) return "left_drive_wheel";
    if (device_id == 11) return "right_drive_wheel";
    if (device_id == 20) return "turret_yaw";
    if (device_id == 21) return "turret_pitch";
    if (device_id == 22) return "flywheel_left";
    if (device_id == 23) return "flywheel_right";
    if (device_id == 30) return "conveyor_motor_1";
    if (device_id == 31) return "conveyor_motor_2";
    if (device_id == 100) return "battery_voltage";
    if (device_id == 101) return "motor_current";
    if (device_id == 110) return "main_imu";
    return NULL;
}

/* ========================================================================== */
/*  DEVICE INITIALIZATION                                                     */
/* ========================================================================== */

int mavlink_gen_init_all_devices(void) {
    int result = 0;

    /* Initialize servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        const mavlink_gen_servo_config_t* cfg = &mavlink_gen_servo_configs[i];

        servo_config_t servo_cfg = {
            .id = cfg->id,
            .timer_id = cfg->timer_id,
            .channel = cfg->channel,
            .min_pulse_us = cfg->min_pulse_us,
            .max_pulse_us = cfg->max_pulse_us,
            .enabled = true,
        };

        servo_controllers[i] = servo_controller_create(&servo_cfg);
        if (!servo_controllers[i]) {
            result = -1;
            /* Continue to initialize other devices */
        }
    }

    /* Initialize DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        const mavlink_gen_dc_motor_config_t* cfg = &mavlink_gen_dc_motor_configs[i];

        dc_motor_config_t dc_cfg = {
            .id = cfg->id,
            .timer_id = cfg->timer_id,
            .channel = cfg->channel,
            .max_duty_cycle = 1.0f,
            .has_encoder = cfg->has_encoder,
            .encoder_ppr = cfg->encoder_ppr,
            .enabled = true,
        };

        dc_motor_controllers[i] = dc_motor_controller_create(&dc_cfg);
        if (!dc_motor_controllers[i]) {
            result = -1;
        }
    }

    /* Initialize RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        const mavlink_gen_robomaster_config_t* cfg = &mavlink_gen_robomaster_configs[i];

        robomaster_config_t rm_cfg = {
            .id = cfg->id,
            .can_id = cfg->can_id,
            .motor_type = cfg->motor_type,
            .enabled = true,
        };

        robomaster_controllers[i] = robomaster_controller_create(&rm_cfg);
        if (!robomaster_controllers[i]) {
            result = -1;
        }
    }

    /* Initialize RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        const mavlink_gen_rs485_config_t* cfg = &mavlink_gen_rs485_configs[i];

        rs485_config_t rs485_cfg = {
            .id = cfg->id,
            .rs485_device_id = cfg->rs485_device_id,
            .uart_id = cfg->uart_port,
            .control_mode = cfg->control_mode,
            .max_rps = cfg->max_rps,
            .enabled = true,
        };

        rs485_controllers[i] = rs485_controller_create(&rs485_cfg);
        if (!rs485_controllers[i]) {
            result = -1;
        }
    }

    return result;
}

/* ========================================================================== */
/*  DEVICE UPDATE                                                             */
/* ========================================================================== */

int mavlink_gen_update_all_devices(void) {
    /* Update servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        if (servo_controllers[i]) {
            servo_controller_update(servo_controllers[i]);
        }
    }

    /* Update DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        if (dc_motor_controllers[i]) {
            dc_motor_controller_update(dc_motor_controllers[i]);
        }
    }

    /* Update RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        if (robomaster_controllers[i]) {
            robomaster_controller_update(robomaster_controllers[i]);
        }
    }

    /* Update RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            rs485_controller_update(rs485_controllers[i]);
        }
    }

    return 0;
}

/* ========================================================================== */
/*  EMERGENCY STOP                                                            */
/* ========================================================================== */

void mavlink_gen_emergency_stop_all(void) {
    /* Stop servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        if (servo_controllers[i]) {
            servo_controller_set_angle(servo_controllers[i],
                mavlink_gen_servo_configs[i].neutral_angle);
        }
    }

    /* Stop DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        if (dc_motor_controllers[i]) {
            dc_motor_controller_set_duty_cycle(dc_motor_controllers[i], 0.0f);
        }
    }

    /* Stop RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        if (robomaster_controllers[i]) {
            robomaster_controller_set_current(robomaster_controllers[i], 0.0f);
        }
    }

    /* Stop RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            rs485_controller_set_velocity(rs485_controllers[i], 0.0f);
        }
    }
}
