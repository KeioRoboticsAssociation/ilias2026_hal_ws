/**
 * @file mavlink_generated_devices.c
 * @brief Auto-generated device initialization and management
 *
 * Generated from: h753_rs485_test.yaml
 * Platform: STM32
 * Generated: 2025-11-15T03:18:14.497411
 * Checksum: c10fc78c38e717f6
 * Generator Version: 1.0.0
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Any changes will be overwritten on next generation.
 */

#include "mavlink_generated_config.h"
#include "mavlink_generated_params.h"

/* Include platform-specific headers */
#ifdef STM32H7xx
#include "stm32h7xx_hal.h"
#elif defined(STM32F4xx)
#include "stm32f4xx_hal.h"
#elif defined(STM32F7xx)
#include "stm32f7xx_hal.h"
#endif

/* Include motor controllers */
#include "motors/rs485_controller.h"

/* Include hardware manager */
#include "hal/hardware_manager.h"

/* ========================================================================== */
/*  SERVO CONFIGURATION DATA                                                  */
/* ========================================================================== */


/* ========================================================================== */
/*  DC MOTOR CONFIGURATION DATA                                               */
/* ========================================================================== */


/* ========================================================================== */
/*  ROBOMASTER MOTOR CONFIGURATION DATA                                       */
/* ========================================================================== */


/* ========================================================================== */
/*  RS485 MOTOR CONFIGURATION DATA                                            */
/* ========================================================================== */

const mavlink_gen_rs485_config_t mavlink_gen_rs485_configs[MAVLINK_GEN_RS485_MOTOR_COUNT] = {
    {
        .id = 30,
        .name = "conveyor_motor_1",
        .uart_port = 1,
        .rs485_device_id = 1,
        .motor_index = 0,
        .control_mode = RS485_MODE_VELOCITY,
        .max_rps = 100.000000f,
    },
    {
        .id = 31,
        .name = "conveyor_motor_2",
        .uart_port = 1,
        .rs485_device_id = 1,
        .motor_index = 1,
        .control_mode = RS485_MODE_VELOCITY,
        .max_rps = 80.000000f,
    },
    {
        .id = 32,
        .name = "lift_motor",
        .uart_port = 1,
        .rs485_device_id = 1,
        .motor_index = 2,
        .control_mode = RS485_MODE_VELOCITY,
        .max_rps = 50.000000f,
    },
};

/* RS485 controller storage */
static motor_controller_t rs485_controllers_storage[MAVLINK_GEN_RS485_MOTOR_COUNT];
static rs485_private_t rs485_private_data[MAVLINK_GEN_RS485_MOTOR_COUNT];
static motor_controller_t* rs485_controllers[MAVLINK_GEN_RS485_MOTOR_COUNT];

/* ========================================================================== */
/*  IMU SENSOR CONFIGURATION DATA                                             */
/* ========================================================================== */


/* ========================================================================== */
/*  GPS MODULE CONFIGURATION DATA                                             */
/* ========================================================================== */


/* ========================================================================== */
/*  ANALOG SENSOR CONFIGURATION DATA                                          */
/* ========================================================================== */


/* ========================================================================== */
/*  DEVICE NAME LOOKUP                                                        */
/* ========================================================================== */

const char* mavlink_gen_get_device_name(uint8_t device_id) {
    if (device_id == 30) return "conveyor_motor_1";
    if (device_id == 31) return "conveyor_motor_2";
    if (device_id == 32) return "lift_motor";
    return NULL;
}

/* ========================================================================== */
/*  DEVICE INITIALIZATION                                                     */
/* ========================================================================== */

int mavlink_gen_init_all_devices(void) {
    int result = 0;




    /* Initialize RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        const mavlink_gen_rs485_config_t* cfg = &mavlink_gen_rs485_configs[i];

        rs485_config_t rs485_cfg = {
            .id = cfg->id,
            .rs485_device_id = cfg->rs485_device_id,
            .motor_index = cfg->motor_index,
            .uart_id = cfg->uart_port,
            .control_mode = cfg->control_mode,
            .max_rps = cfg->max_rps,
            .max_acceleration_rps2 = 200.0f,
            .max_count = 8192,
            .max_rotation = 100,
            .watchdog_timeout_ms = 1000,
            .retry_count = 3,
        };

        error_code_t err = rs485_controller_create(
            cfg->id,
            &rs485_cfg,
            &rs485_controllers_storage[i],
            &rs485_private_data[i]
        );

        if (err == ERROR_OK) {
            rs485_controllers[i] = &rs485_controllers_storage[i];
        } else {
            rs485_controllers[i] = NULL;
            result = -1;
        }
    }

    return result;
}

/* ========================================================================== */
/*  DEVICE UPDATE                                                             */
/* ========================================================================== */

int mavlink_gen_update_all_devices(void) {
    static uint32_t last_time_ms = 0;
    uint32_t current_time_ms = HAL_GetTick();
    float delta_time = (last_time_ms == 0) ? 0.01f : (current_time_ms - last_time_ms) / 1000.0f;
    last_time_ms = current_time_ms;




    /* Update RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            motor_update(rs485_controllers[i], delta_time);
        }
    }

    return 0;
}

/* ========================================================================== */
/*  EMERGENCY STOP                                                            */
/* ========================================================================== */

void mavlink_gen_emergency_stop_all(void) {



    /* Stop RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            motor_emergency_stop(rs485_controllers[i]);
        }
    }
}

/* ========================================================================== */
/*  UNIFIED MOTOR ACCESS                                                      */
/* ========================================================================== */

/**
 * @brief Get motor controller by ID
 * @param motor_id Motor ID (1-255)
 * @return Pointer to motor controller, or NULL if not found
 */
motor_controller_t* mavlink_gen_get_controller_by_id(uint8_t motor_id) {



    /* RS485 motors: 30-49 */
    if (motor_id >= 30 && motor_id <= 49) {
        for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
            if (rs485_controllers[i] && rs485_controllers[i]->id == motor_id) {
                return rs485_controllers[i];
            }
        }
    }

    return NULL;
}
