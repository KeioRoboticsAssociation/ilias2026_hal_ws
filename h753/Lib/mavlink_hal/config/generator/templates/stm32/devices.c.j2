/**
 * @file mavlink_generated_devices.c
 * @brief Auto-generated device initialization and management
 *
 * Generated from: {{ config_file }}
 * Platform: {{ platform.type | upper }}
 * Generated: {{ generated_timestamp }}
 * Generator Version: {{ generator_version }}
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Any changes will be overwritten on next generation.
 */

#include "mavlink_generated_config.h"
#include "mavlink_generated_params.h"

/* Include platform-specific headers */
#ifdef STM32H7xx
#include "stm32h7xx_hal.h"
#elif defined(STM32F4xx)
#include "stm32f4xx_hal.h"
#elif defined(STM32F7xx)
#include "stm32f7xx_hal.h"
#endif

/* Include motor controllers */
{% if servo_count > 0 %}
#include "App/motors/servo_controller.h"
{% endif %}
{% if dc_motor_count > 0 %}
#include "App/motors/dc_controller.h"
{% endif %}
{% if robomaster_count > 0 %}
#include "App/motors/robomaster_controller.h"
{% endif %}
{% if rs485_motor_count > 0 %}
#include "App/motors/rs485_controller.h"
{% endif %}

/* Include hardware manager */
#include "App/hal/hardware_manager.h"

/* ========================================================================== */
/*  SERVO CONFIGURATION DATA                                                  */
/* ========================================================================== */

{% if servo_count > 0 %}
const mavlink_gen_servo_config_t mavlink_gen_servo_configs[MAVLINK_GEN_SERVO_COUNT] = {
{% for device in devices_by_type.servo %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .timer_id = {{ device.hardware.timer }},
        .channel = TIM_CHANNEL_{{ device.hardware.channel }},
        .min_pulse_us = {{ device.config.servo.min_pulse_us | default(1000) }},
        .max_pulse_us = {{ device.config.servo.max_pulse_us | default(2000) }},
{% if device.limits %}
        .min_angle = {{ device.limits.min_value | default(-90.0) | format_float }},
        .max_angle = {{ device.limits.max_value | default(90.0) | format_float }},
{% else %}
        .min_angle = -90.0f,
        .max_angle = 90.0f,
{% endif %}
        .neutral_angle = {{ device.config.servo.neutral_angle | default(0.0) | format_float }},
    },
{% endfor %}
};

/* Servo controller instances */
static servo_controller_t* servo_controllers[MAVLINK_GEN_SERVO_COUNT];
{% endif %}

/* ========================================================================== */
/*  DC MOTOR CONFIGURATION DATA                                               */
/* ========================================================================== */

{% if dc_motor_count > 0 %}
const mavlink_gen_dc_motor_config_t mavlink_gen_dc_motor_configs[MAVLINK_GEN_DC_MOTOR_COUNT] = {
{% for device in devices_by_type.dc_motor %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .timer_id = {{ device.hardware.timer }},
        .channel = TIM_CHANNEL_{{ device.hardware.channel }},
{% if device.limits and device.limits.max_speed %}
        .max_rpm = {{ device.limits.max_speed | format_float }},
{% else %}
        .max_rpm = 1000.0f,
{% endif %}
        .has_encoder = {{ 'true' if device.config.dc_motor.encoder else 'false' }},
{% if device.config.dc_motor.encoder %}
        .encoder_ppr = {{ device.config.dc_motor.encoder.ppr | default(1024) }},
{% else %}
        .encoder_ppr = 0,
{% endif %}
    },
{% endfor %}
};

/* DC motor controller instances */
static dc_motor_controller_t* dc_motor_controllers[MAVLINK_GEN_DC_MOTOR_COUNT];
{% endif %}

/* ========================================================================== */
/*  ROBOMASTER MOTOR CONFIGURATION DATA                                       */
/* ========================================================================== */

{% if robomaster_count > 0 %}
const mavlink_gen_robomaster_config_t mavlink_gen_robomaster_configs[MAVLINK_GEN_ROBOMASTER_COUNT] = {
{% for device in devices_by_type.robomaster %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .can_id = {{ device.hardware.can_id | to_hex }},
        .motor_type = ROBOMASTER_MOTOR_TYPE_{{ device.config.robomaster.motor_type | to_upper }},
{% if device.limits and device.limits.max_speed %}
        .max_rpm = {{ device.limits.max_speed | format_float }},
{% else %}
        .max_rpm = 10000.0f,
{% endif %}
{% if device.limits and device.limits.max_current_ma %}
        .max_current = {{ device.limits.max_current_ma }} / 1000.0f,
{% else %}
        .max_current = 10.0f,
{% endif %}
    },
{% endfor %}
};

/* RoboMaster controller instances */
static robomaster_controller_t* robomaster_controllers[MAVLINK_GEN_ROBOMASTER_COUNT];
{% endif %}

/* ========================================================================== */
/*  RS485 MOTOR CONFIGURATION DATA                                            */
/* ========================================================================== */

{% if rs485_motor_count > 0 %}
const mavlink_gen_rs485_config_t mavlink_gen_rs485_configs[MAVLINK_GEN_RS485_MOTOR_COUNT] = {
{% for device in devices_by_type.rs485_motor %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .uart_port = {{ device.hardware.uart_port }},
        .rs485_device_id = {{ device.config.rs485_motor.device_id }},
        .control_mode = RS485_MODE_{{ device.config.rs485_motor.control_mode | to_upper }},
{% if device.limits and device.limits.max_speed %}
        .max_rps = {{ device.limits.max_speed | format_float }},
{% else %}
        .max_rps = 100.0f,
{% endif %}
    },
{% endfor %}
};

/* RS485 controller instances */
static rs485_controller_t* rs485_controllers[MAVLINK_GEN_RS485_MOTOR_COUNT];
{% endif %}

/* ========================================================================== */
/*  IMU SENSOR CONFIGURATION DATA                                             */
/* ========================================================================== */

{% if imu_count > 0 %}
const mavlink_gen_imu_config_t mavlink_gen_imu_configs[MAVLINK_GEN_IMU_COUNT] = {
{% for device in devices_by_type.imu %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .sensor_type = "{{ device.config.imu.sensor_type }}",
        .i2c_address = {{ device.hardware.i2c_address | to_hex }},
        .sample_rate_hz = {{ device.config.imu.sample_rate_hz | default(100) }},
    },
{% endfor %}
};
{% endif %}

/* ========================================================================== */
/*  GPS MODULE CONFIGURATION DATA                                             */
/* ========================================================================== */

{% if gps_count > 0 %}
const mavlink_gen_gps_config_t mavlink_gen_gps_configs[MAVLINK_GEN_GPS_COUNT] = {
{% for device in devices_by_type.gps %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .module_type = "{{ device.config.gps.module_type }}",
        .uart_port = "{{ device.hardware.uart_port }}",
        .baudrate = {{ device.config.gps.baudrate | default(9600) }},
    },
{% endfor %}
};
{% endif %}

/* ========================================================================== */
/*  ANALOG SENSOR CONFIGURATION DATA                                          */
/* ========================================================================== */

{% if analog_sensor_count > 0 %}
const mavlink_gen_analog_sensor_config_t mavlink_gen_analog_sensor_configs[MAVLINK_GEN_ANALOG_SENSOR_COUNT] = {
{% for device in devices_by_type.analog_sensor %}
    {
        .id = {{ device.id }},
        .name = "{{ device.name }}",
        .sensor_type = ANALOG_SENSOR_{{ device.config.analog_sensor.sensor_type | to_upper }},
        .adc_channel = "{{ device.hardware.adc_channel }}",
        .scale_factor = {{ device.config.analog_sensor.scale_factor | default(1.0) | format_float }},
        .offset = {{ device.config.analog_sensor.offset | default(0.0) | format_float }},
    },
{% endfor %}
};
{% endif %}

/* ========================================================================== */
/*  DEVICE NAME LOOKUP                                                        */
/* ========================================================================== */

const char* mavlink_gen_get_device_name(uint8_t device_id) {
{% for device in devices %}
    if (device_id == {{ device.id }}) return "{{ device.name }}";
{% endfor %}
    return NULL;
}

/* ========================================================================== */
/*  DEVICE INITIALIZATION                                                     */
/* ========================================================================== */

int mavlink_gen_init_all_devices(void) {
    int result = 0;

{% if servo_count > 0 %}
    /* Initialize servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        const mavlink_gen_servo_config_t* cfg = &mavlink_gen_servo_configs[i];

        servo_config_t servo_cfg = {
            .id = cfg->id,
            .timer_id = cfg->timer_id,
            .channel = cfg->channel,
            .min_pulse_us = cfg->min_pulse_us,
            .max_pulse_us = cfg->max_pulse_us,
            .enabled = true,
        };

        servo_controllers[i] = servo_controller_create(&servo_cfg);
        if (!servo_controllers[i]) {
            result = -1;
            /* Continue to initialize other devices */
        }
    }
{% endif %}

{% if dc_motor_count > 0 %}
    /* Initialize DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        const mavlink_gen_dc_motor_config_t* cfg = &mavlink_gen_dc_motor_configs[i];

        dc_motor_config_t dc_cfg = {
            .id = cfg->id,
            .timer_id = cfg->timer_id,
            .channel = cfg->channel,
            .max_duty_cycle = 1.0f,
            .has_encoder = cfg->has_encoder,
            .encoder_ppr = cfg->encoder_ppr,
            .enabled = true,
        };

        dc_motor_controllers[i] = dc_motor_controller_create(&dc_cfg);
        if (!dc_motor_controllers[i]) {
            result = -1;
        }
    }
{% endif %}

{% if robomaster_count > 0 %}
    /* Initialize RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        const mavlink_gen_robomaster_config_t* cfg = &mavlink_gen_robomaster_configs[i];

        robomaster_config_t rm_cfg = {
            .id = cfg->id,
            .can_id = cfg->can_id,
            .motor_type = cfg->motor_type,
            .enabled = true,
        };

        robomaster_controllers[i] = robomaster_controller_create(&rm_cfg);
        if (!robomaster_controllers[i]) {
            result = -1;
        }
    }
{% endif %}

{% if rs485_motor_count > 0 %}
    /* Initialize RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        const mavlink_gen_rs485_config_t* cfg = &mavlink_gen_rs485_configs[i];

        rs485_config_t rs485_cfg = {
            .id = cfg->id,
            .rs485_device_id = cfg->rs485_device_id,
            .uart_id = cfg->uart_port,
            .control_mode = cfg->control_mode,
            .max_rps = cfg->max_rps,
            .enabled = true,
        };

        rs485_controllers[i] = rs485_controller_create(&rs485_cfg);
        if (!rs485_controllers[i]) {
            result = -1;
        }
    }
{% endif %}

    return result;
}

/* ========================================================================== */
/*  DEVICE UPDATE                                                             */
/* ========================================================================== */

int mavlink_gen_update_all_devices(void) {
{% if servo_count > 0 %}
    /* Update servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        if (servo_controllers[i]) {
            servo_controller_update(servo_controllers[i]);
        }
    }
{% endif %}

{% if dc_motor_count > 0 %}
    /* Update DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        if (dc_motor_controllers[i]) {
            dc_motor_controller_update(dc_motor_controllers[i]);
        }
    }
{% endif %}

{% if robomaster_count > 0 %}
    /* Update RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        if (robomaster_controllers[i]) {
            robomaster_controller_update(robomaster_controllers[i]);
        }
    }
{% endif %}

{% if rs485_motor_count > 0 %}
    /* Update RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            rs485_controller_update(rs485_controllers[i]);
        }
    }
{% endif %}

    return 0;
}

/* ========================================================================== */
/*  EMERGENCY STOP                                                            */
/* ========================================================================== */

void mavlink_gen_emergency_stop_all(void) {
{% if servo_count > 0 %}
    /* Stop servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT; i++) {
        if (servo_controllers[i]) {
            servo_controller_set_angle(servo_controllers[i],
                mavlink_gen_servo_configs[i].neutral_angle);
        }
    }
{% endif %}

{% if dc_motor_count > 0 %}
    /* Stop DC motors */
    for (int i = 0; i < MAVLINK_GEN_DC_MOTOR_COUNT; i++) {
        if (dc_motor_controllers[i]) {
            dc_motor_controller_set_duty_cycle(dc_motor_controllers[i], 0.0f);
        }
    }
{% endif %}

{% if robomaster_count > 0 %}
    /* Stop RoboMaster motors */
    for (int i = 0; i < MAVLINK_GEN_ROBOMASTER_COUNT; i++) {
        if (robomaster_controllers[i]) {
            robomaster_controller_set_current(robomaster_controllers[i], 0.0f);
        }
    }
{% endif %}

{% if rs485_motor_count > 0 %}
    /* Stop RS485 motors */
    for (int i = 0; i < MAVLINK_GEN_RS485_MOTOR_COUNT; i++) {
        if (rs485_controllers[i]) {
            rs485_controller_set_velocity(rs485_controllers[i], 0.0f);
        }
    }
{% endif %}
}
