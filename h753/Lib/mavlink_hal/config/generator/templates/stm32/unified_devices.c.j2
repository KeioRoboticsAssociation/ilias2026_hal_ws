/**
 * @file mavlink_unified_devices.c
 * @brief Unified device implementations (auto-generated)
 *
 * This file was automatically generated by MAVLink HAL Code Generator
 * from configuration: {{ config_file }}
 *
 * Generated: {{ generation_timestamp }}
 * Generator Version: {{ generator_version }}
 * Platform: {{ platform.type }}
 * MCU: {{ platform.mcu.model }}
 *
 * DO NOT EDIT THIS FILE MANUALLY
 * Changes will be lost when regenerating from configuration
 */

#include "mavlink_unified_devices.h"
#include <stdlib.h>
#include <string.h>

/* Platform-specific includes */
#ifdef STM32H7
#include "stm32h7xx_hal.h"
{% if has_can_devices %}
#include "fdcan.h"
{% endif %}
#elif defined(STM32F4)
#include "stm32f4xx_hal.h"
{% if has_can_devices %}
#include "can.h"
{% endif %}
#endif

/* Timer and peripheral handles (extern declarations) */
{% for timer_id in timer_ids %}
extern TIM_HandleTypeDef htim{{ timer_id }};
{% endfor %}
{% for uart_id in uart_ids %}
extern UART_HandleTypeDef huart{{ uart_id }};
{% endfor %}
{% if has_can_devices %}
#ifdef STM32H7
extern FDCAN_HandleTypeDef hfdcan1;
#elif defined(STM32F4)
extern CAN_HandleTypeDef hcan1;
#endif
{% endif %}

/* ========================================================================== */
/*  DEVICE STORAGE                                                            */
/* ========================================================================== */

{% for device in devices %}
mavlink_device_t* g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = NULL;
{% endfor %}

/* ========================================================================== */
/*  DEVICE INITIALIZATION                                                     */
/* ========================================================================== */

mavlink_device_error_t unified_devices_init(void)
{
    mavlink_device_error_t err;

    /* Initialize device registry */
    err = mavlink_device_registry_init();
    if (err != MAVLINK_DEVICE_ERROR_NONE) {
        return err;
    }

{% for device in devices %}
    /* -------------------------------------------------------------------- */
    /* Device {{ device.id }}: {{ device.name }} ({{ device.type }})
    /* -------------------------------------------------------------------- */

{% if device.type == 'servo' %}
    /* Servo configuration */
    mavlink_device_config_t config_{{ device.id }} = {
        .type = MAVLINK_DEVICE_TYPE_SERVO,
        .limits = {
            .min_position = {{ device.limits.min_value | default(-90.0) }}f,
            .max_position = {{ device.limits.max_value | default(90.0) }}f,
        },
        .failsafe = {
            .action = MAVLINK_FAILSAFE_{{ device.failsafe.action | upper | default('NEUTRAL') }},
            .timeout_ms = {{ device.failsafe.timeout_ms | default(1000) }},
        },
        .config.servo = {
            .min_pulse_us = {{ device.config.servo.min_pulse_us | default(1000) }},
            .max_pulse_us = {{ device.config.servo.max_pulse_us | default(2000) }},
            .neutral_angle = {{ device.config.servo.neutral_angle | default(0.0) }}f,
        },
    };

    /* Create servo device */
    g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = servo_device_create(
        {{ device.id }},                    /* Device ID */
        "{{ device.name }}",                /* Name */
        &config_{{ device.id }},
        &htim{{ device.hardware.timer }},  /* Timer handle */
        TIM_CHANNEL_{{ device.hardware.channel }},
        {{ platform.mcu.clock_mhz }}000000  /* Timer frequency */
    );

{% elif device.type == 'dc_motor' %}
    /* DC motor configuration */
    mavlink_device_config_t config_{{ device.id }} = {
        .type = MAVLINK_DEVICE_TYPE_DC_MOTOR,
        .limits = {
            .min_position = {{ device.limits.min_position | default(-100.0) }}f,
            .max_position = {{ device.limits.max_position | default(100.0) }}f,
            .max_velocity = {{ device.limits.max_velocity | default(50.0) }}f,
        },
        .pid_position = {
            .kp = {{ device.config.dc_motor.pid_position.kp | default(0.5) }}f,
            .ki = {{ device.config.dc_motor.pid_position.ki | default(0.01) }}f,
            .kd = {{ device.config.dc_motor.pid_position.kd | default(0.1) }}f,
        },
        .pid_velocity = {
            .kp = {{ device.config.dc_motor.pid_velocity.kp | default(0.12) }}f,
            .ki = {{ device.config.dc_motor.pid_velocity.ki | default(0.02) }}f,
            .kd = {{ device.config.dc_motor.pid_velocity.kd | default(0.0) }}f,
        },
        .failsafe = {
            .action = MAVLINK_FAILSAFE_{{ device.failsafe.action | upper | default('DISABLE') }},
            .timeout_ms = {{ device.failsafe.timeout_ms | default(1000) }},
        },
    };

    /* Create DC motor device */
    g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = dc_motor_device_create(
        {{ device.id }},                    /* Device ID */
        "{{ device.name }}",                /* Name */
        &config_{{ device.id }},
        &htim{{ device.hardware.timer_pwm }},      /* PWM timer */
        TIM_CHANNEL_{{ device.hardware.channel_fwd }}, /* Forward channel */
        TIM_CHANNEL_{{ device.hardware.channel_rev }}, /* Reverse channel */
        &htim{{ device.hardware.timer_encoder }},  /* Encoder timer */
        {{ platform.mcu.clock_mhz }}000000, /* PWM frequency */
        {{ device.config.dc_motor.encoder_counts_per_rev | default(2048.0) }}f,
        {{ device.config.dc_motor.gear_ratio | default(1.0) }}f
    );

{% elif device.type == 'robomaster' %}
    /* RoboMaster configuration */
    mavlink_device_config_t config_{{ device.id }} = {
        .type = MAVLINK_DEVICE_TYPE_ROBOMASTER,
        .pid_velocity = {
            .kp = {{ device.config.robomaster.pid_speed.kp | default(50.0) }}f,
            .ki = {{ device.config.robomaster.pid_speed.ki | default(0.1) }}f,
            .kd = {{ device.config.robomaster.pid_speed.kd | default(0.0) }}f,
        },
        .pid_position = {
            .kp = {{ device.config.robomaster.pid_angle.kp | default(1.0) }}f,
            .ki = {{ device.config.robomaster.pid_angle.ki | default(0.0) }}f,
            .kd = {{ device.config.robomaster.pid_angle.kd | default(0.5) }}f,
        },
        .failsafe = {
            .action = MAVLINK_FAILSAFE_{{ device.failsafe.action | upper | default('DISABLE') }},
            .timeout_ms = {{ device.failsafe.timeout_ms | default(1000) }},
        },
    };

    /* Create RoboMaster device */
    g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = robomaster_device_create(
        {{ device.id }},                    /* Device ID */
        "{{ device.name }}",                /* Name */
        &config_{{ device.id }},
#ifdef STM32H7
        &hfdcan1,                           /* CAN handle */
#elif defined(STM32F4)
        &hcan1,
#endif
        {{ device.hardware.can_id }},      /* CAN ID */
        ROBOMASTER_TYPE_{{ device.config.robomaster.motor_type | upper }}
    );

{% elif device.type == 'rs485_motor' %}
    /* RS485 motor configuration */
    mavlink_device_config_t config_{{ device.id }} = {
        .type = MAVLINK_DEVICE_TYPE_RS485_MOTOR,
        .limits = {
            .max_velocity = {{ device.limits.max_speed | default(100.0) }}f,
        },
        .failsafe = {
            .action = MAVLINK_FAILSAFE_{{ device.failsafe.action | upper | default('DISABLE') }},
            .timeout_ms = {{ device.failsafe.timeout_ms | default(1000) }},
        },
    };

    /* Create RS485 motor device */
    g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = rs485_motor_device_create(
        {{ device.id }},                    /* Device ID */
        "{{ device.name }}",                /* Name */
        &config_{{ device.id }},
        &huart{{ device.hardware.uart }},  /* UART handle */
        {{ device.config.rs485_motor.device_id | default(1) }}, /* RS485 device ID */
        {{ device.limits.max_speed | default(100.0) }}f,
        {{ device.config.rs485_motor.max_acceleration | default(200.0) }}f
    );

{% elif device.type == 'encoder' %}
    /* Encoder configuration */
    mavlink_device_config_t config_{{ device.id }} = {
        .type = MAVLINK_DEVICE_TYPE_ENCODER,
    };

    /* Create encoder device */
    g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = encoder_device_create(
        {{ device.id }},                    /* Device ID */
        "{{ device.name }}",                /* Name */
        &config_{{ device.id }},
        &htim{{ device.hardware.timer }},  /* Encoder timer */
        {{ platform.mcu.clock_mhz }}000000, /* Timer frequency */
        {{ device.config.encoder.counts_per_rev | default(2048.0) }}f,
        {{ device.config.encoder.gear_ratio | default(1.0) }}f
    );

{% endif %}
    /* Check device creation */
    if (!g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }}) {
        return MAVLINK_DEVICE_ERROR_NOT_INITIALIZED;
    }

    /* Register device */
    err = mavlink_device_registry_register(g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }});
    if (err != MAVLINK_DEVICE_ERROR_NONE) {
        return err;
    }

    /* Enable device */
    err = mavlink_device_enable(g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }}, true);
    if (err != MAVLINK_DEVICE_ERROR_NONE) {
        return err;
    }

{% endfor %}
    return MAVLINK_DEVICE_ERROR_NONE;
}

mavlink_device_error_t unified_devices_shutdown(void)
{
    mavlink_device_error_t err;

{% for device in devices %}
    /* Shutdown device {{ device.id }}: {{ device.name }} */
    if (g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }}) {
        mavlink_device_shutdown(g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }});
        free(g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }});
        g_device_{{ device.id }}_{{ device.name | replace('-', '_') | replace(' ', '_') }} = NULL;
    }
{% endfor %}

    return MAVLINK_DEVICE_ERROR_NONE;
}

mavlink_device_t* unified_devices_get(uint8_t device_id)
{
    return mavlink_device_registry_find(device_id);
}

uint32_t unified_devices_count(void)
{
    return mavlink_device_registry_count();
}
