/**
 * @file mavlink_generated_handlers.cpp
 * @brief Auto-generated MAVLink message handlers for Arduino
 *
 * Generated from: {{ config_file }}
 * Platform: {{ platform.type | upper }}
 * Generated: {{ generated_timestamp }}
 * Generator Version: {{ generator_version }}
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Any changes will be overwritten on next generation.
 */

#include "mavlink_generated_config.h"

/* Include MAVLink library */
#include "common/mavlink.h"

/* Forward declarations of device control functions */
{% if servo_count > 0 %}
extern void setServoAngle(int servoIndex, float angle);
{% endif %}
{% if dc_motor_count > 0 %}
extern void setDCMotorSpeed(int motorIndex, float speed);
{% endif %}
{% if bldc_motor_count > 0 %}
extern void setBLDCMotorThrottle(int motorIndex, float throttle);
{% endif %}

/* ========================================================================== */
/*  RC_CHANNELS_OVERRIDE HANDLER                                              */
/* ========================================================================== */

/**
 * @brief Handle RC_CHANNELS_OVERRIDE message (ID 70)
 */
void mavlinkGenHandleRCChannelsOverride(const mavlink_message_t* msg) {
    mavlink_rc_channels_override_t rc;
    mavlink_msg_rc_channels_override_decode(msg, &rc);

    /* RC channels 1-8 map to device IDs 1-8 (typically servos) */
    uint16_t channels[8] = {
        rc.chan1_raw, rc.chan2_raw, rc.chan3_raw, rc.chan4_raw,
        rc.chan5_raw, rc.chan6_raw, rc.chan7_raw, rc.chan8_raw
    };

{% if servo_count > 0 %}
    /* Map to servos */
    for (int i = 0; i < MAVLINK_GEN_SERVO_COUNT && i < 8; i++) {
        uint8_t deviceId = servoConfigs[i].id;

        if (deviceId >= 1 && deviceId <= 8) {
            uint16_t pwm = channels[deviceId - 1];

            if (pwm >= 1000 && pwm <= 2000) {
                /* Convert PWM to angle */
                float angle = map(pwm, 1000, 2000,
                                  servoConfigs[i].min_angle * 100,
                                  servoConfigs[i].max_angle * 100) / 100.0f;

                setServoAngle(i, angle);
            }
        }
    }
{% endif %}
}

/* ========================================================================== */
/*  MANUAL_CONTROL HANDLER                                                    */
/* ========================================================================== */

/**
 * @brief Handle MANUAL_CONTROL message (ID 69)
 */
void mavlinkGenHandleManualControl(const mavlink_message_t* msg) {
    mavlink_manual_control_t manual;
    mavlink_msg_manual_control_decode(msg, &manual);

    /* Axes: x, y, z, r (range: -1000 to +1000) */
    float xNorm = manual.x / 1000.0f;
    float yNorm = manual.y / 1000.0f;
    float zNorm = manual.z / 1000.0f;
    float rNorm = manual.r / 1000.0f;

{% if dc_motor_count >= 2 %}
    /* Differential drive example */
    float leftSpeed = (zNorm + rNorm);
    float rightSpeed = (zNorm - rNorm);

    setDCMotorSpeed(0, leftSpeed);
    setDCMotorSpeed(1, rightSpeed);
{% elif bldc_motor_count == 4 %}
    /* Quadcopter throttle control */
    float throttle = (zNorm + 1.0f) / 2.0f;  /* Convert to 0-1 range */

    for (int i = 0; i < 4; i++) {
        setBLDCMotorThrottle(i, throttle);
    }
{% endif %}
}

/* ========================================================================== */
/*  MAIN MESSAGE DISPATCHER                                                   */
/* ========================================================================== */

/**
 * @brief Dispatch MAVLink message to appropriate handler
 */
void mavlinkGenHandleMessage(const mavlink_message_t* msg) {
    switch (msg->msgid) {
        case MAVLINK_MSG_ID_RC_CHANNELS_OVERRIDE:
            mavlinkGenHandleRCChannelsOverride(msg);
            break;

        case MAVLINK_MSG_ID_MANUAL_CONTROL:
            mavlinkGenHandleManualControl(msg);
            break;

        default:
            /* Unhandled message */
            break;
    }
}
