# MAVLink Device Configuration - STM32H753 Rover
# This configuration demonstrates the new 3-motor RS485 protocol
# Each RS485 board can control 3 motors simultaneously with 16-byte packets

platform:
  type: stm32
  mcu:
    model: STM32H753ZI
    clock_mhz: 480
    flash_kb: 2048
    ram_kb: 1024
    voltage: 3.3
  board: NUCLEO-H753ZI

mavlink:
  system_id: 1
  component_id: 1  # MAV_COMP_ID_ONBOARD_COMPUTER
  transport:
    type: udp
    udp:
      local_ip: "192.168.11.4"
      local_port: 14550
      remote_ip: "192.168.11.2"
      remote_port: 14550
  heartbeat_rate_hz: 1.0
  telemetry_rate_hz: 10.0

devices:
  # ========================================================================
  # RS485 Board #1 - 3 motors (MAVLink IDs 30-32)
  # ========================================================================
  # All 3 motors share the same RS485 board with device_id=1 (DIP switch)
  # The board communicates via USART1 using 16-byte packets:
  #   - Header (1 byte) + Board ID (1 byte) + Payload (12 bytes) + CRC (2 bytes)
  #   - Payload contains 3 × 4-byte values (velocity: 3 floats, position: 3 × (int16 + int16))

  - id: 30
    type: rs485_motor
    name: conveyor_motor_1
    enabled: true
    hardware:
      uart: USART1
      pins:
        tx: PA9
        rx: PA10
    config:
      rs485_motor:
        device_id: 1        # RS485 board ID (1-8, set via DIP switch)
        motor_index: 0      # First motor on this board (0, 1, or 2)
        control_mode: velocity
        max_velocity_rps: 100.0
        max_acceleration_rps2: 200.0
        encoder_resolution: 8192
        retry_count: 3
    limits:
      max_speed: 100  # RPS
      max_temperature_c: 85
    failsafe:
      action: disable
      timeout_ms: 1000

  - id: 31
    type: rs485_motor
    name: conveyor_motor_2
    enabled: true
    hardware:
      uart: USART1        # Same UART as motor 30
      pins:
        tx: PA9
        rx: PA10
    config:
      rs485_motor:
        device_id: 1        # Same RS485 board as motor 30
        motor_index: 1      # Second motor on this board
        control_mode: velocity
        max_velocity_rps: 80.0
        max_acceleration_rps2: 150.0
        encoder_resolution: 8192
        retry_count: 3
    limits:
      max_speed: 80  # RPS
      max_temperature_c: 85
    failsafe:
      action: disable
      timeout_ms: 1000

  - id: 32
    type: rs485_motor
    name: lift_motor
    enabled: true
    hardware:
      uart: USART1        # Same UART as motors 30-31
      pins:
        tx: PA9
        rx: PA10
    config:
      rs485_motor:
        device_id: 1        # Same RS485 board as motors 30-31
        motor_index: 2      # Third motor on this board
        control_mode: velocity
        max_velocity_rps: 50.0
        max_acceleration_rps2: 100.0
        encoder_resolution: 8192
        retry_count: 3
    limits:
      max_speed: 50  # RPS
      max_temperature_c: 85
    failsafe:
      action: hold
      timeout_ms: 1000

system:
  update_rate_hz: 100  # 100Hz main control loop
  emergency_stop_pin: PC13  # Blue button on Nucleo
  status_led_pin: PB0      # Green LED (LD1)
  debug:
    enabled: true
    level: info
    output: uart
