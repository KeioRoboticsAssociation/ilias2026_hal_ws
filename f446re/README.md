# MAVLink-Controlled Motor Driver for STM32

This repository contains the firmware for an advanced motor controller based on the STM32F446RE microcontroller. The system is designed to control a variety of motors, including servos, DC motors, and RoboMaster motors, through the MAVLink communication protocol.

## Features

- **MAVLink Communication**: Controlled via MAVLink messages over a serial interface.
- **Multi-Motor Support**: Supports servos, DC motors, and RoboMaster motors.
- **Parameter Storage**: Persistent parameter storage on the onboard flash memory.
- **Error Recovery**: Built-in error recovery and safety mechanisms.
- **Plugin System**: A flexible plugin system for extending functionality.

## Project Structure

The project is organized into the following directories:

- `App/`: Contains the main application logic.
  - `comm/`: MAVLink communication and message handling.
  - `config/`: System and device configuration.
  - `hal/`: Hardware Abstraction Layer (HAL).
  - `motors/`: Motor control logic.
  - `storage/`: Flash storage and parameter management.
- `Core/`: Core STM32 files generated by CubeMX.
- `Drivers/`: STM32 HAL drivers and CMSIS.
- `Inc/`: Main header files.
- `Src/`: Main source files.
- `Lib/`: Third-party libraries (e.g., MAVLink).

## Setup

### Hardware

- **Microcontroller**: STM32F446RE (e.g., NUCLEO-F446RE board)
- **Communication**: A USB-to-serial adapter for connecting to a computer.

### Toolchain

- **Compiler**: `arm-none-eabi-gcc`
- **Build System**: `cmake` and `make`
- **IDE**: STM32CubeIDE (optional, for debugging and code generation)

### Building the Firmware

1. **Clone the repository:**
   ```sh
   git clone <repository-url>
   cd <repository-directory>
   ```

2. **Initialize submodules (if any):**
   ```sh
   git submodule update --init --recursive
   ```

3. **Build the project:**
   ```sh
   mkdir build
   cd build
   cmake ..
   make
   ```

4. **Flash the firmware:**
   Use an ST-Link programmer or the built-in programmer on a Nucleo board to flash the generated `.bin` or `.elf` file to the microcontroller.

## Usage

The motor controller is operated by sending MAVLink commands over a serial connection.

- **Serial Port**: `USART2`
- **Baud Rate**: 115200

You can use a ground control station (GCS) like QGroundControl or a custom script to send MAVLink commands to the device. The following are some of the supported MAVLink messages:

- `RC_CHANNELS_OVERRIDE`: To control motors using raw PWM values.
- `MANUAL_CONTROL`: To control motors using joystick-like inputs.
- `PARAM_REQUEST_LIST`, `PARAM_REQUEST_READ`, `PARAM_SET`: For getting and setting parameters.

The system will also send telemetry data, such as heartbeats and motor status, back to the GCS.